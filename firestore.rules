rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- SECURITY HELPERS ---

    // 1. Check if User is Authenticated & Matches OwnerId
    function isOwner(ownerId) {
      return request.auth != null && request.auth.uid == ownerId;
    }

    // 2. Prevent Changing Critical Fields (Anti-Tamper)
    function notUpdating(field) {
      return request.resource.data[field] == resource.data[field];
    }
    
    // 3. Ensure OwnerId is Correct on Create
    function isValidOwner() {
      return request.auth != null && request.resource.data.ownerId == request.auth.uid;
    }

    // --- 1. OWNERS COLLECTION ---
    match /owners/{ownerId} {
      // Users can only touch their own profile
      allow read, write: if request.auth != null && request.auth.uid == ownerId;
    }

    // --- 2. PROPERTIES (HOUSES) ---
    match /houses/{docId} {
      // Create: Must be your own
      allow create: if isValidOwner()
                   && request.resource.data.name is string;
      
      // Update: Must be yours AND cannot change ownerId
      allow update: if isOwner(resource.data.ownerId)
                   && notUpdating('ownerId'); 
      
      // PERMISSION CHANGE: Allow read for Tenants (who are unauthenticated)
      allow read: if true;
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 3. UNITS ---
    match /units/{docId} {
      allow create: if isValidOwner() && request.resource.data.baseRent is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      // PERMISSION CHANGE: Allow read for Tenants
      allow read: if true;
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 4. TENANTS ---
    match /tenants/{docId} {
      allow read: if true;
      allow create: if isValidOwner() && request.resource.data.name is string;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 5. RENT CYCLES (BILLS) ---
    match /rent_cycles/{docId} {
      allow read: if true;
      allow create: if isValidOwner() && request.resource.data.totalDue is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 6. PAYMENTS ---
    match /payments/{docId} {
      allow read: if true; 
      allow create: if isValidOwner() && request.resource.data.amount is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 7. EXPENSES ---
    match /expenses/{docId} {
      allow create: if isValidOwner() && request.resource.data.amount is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow read, delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 8. ELECTRIC READINGS ---
    match /electric_readings/{docId} {
       allow create: if isValidOwner();
       // PERMISSION CHANGE: Allow read for Tenants (receipt generation)
       allow read: if true;
       allow update, delete: if isOwner(resource.data.ownerId);
    }

    // --- 9. BHK TEMPLATES ---
    match /bhkTemplates/{docId} {
       allow create: if isValidOwner();
       allow read, update, delete: if isOwner(resource.data.ownerId);
    }
  }
}
