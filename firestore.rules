rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- SECURITY HELPERS ---

    // 1. Check if User is Authenticated & Matches OwnerId
    function isOwner(ownerId) {
      return request.auth != null && request.auth.uid == ownerId;
    }

    // 2. Prevent Changing Critical Fields (Anti-Tamper)
    function notUpdating(field) {
      return request.resource.data[field] == resource.data[field];
    }
    
    // 3. Ensure OwnerId is Correct on Create
    function isValidOwner() {
      return request.auth != null && request.resource.data.ownerId == request.auth.uid;
    }

    // --- 1. OWNERS COLLECTION ---
    match /owners/{ownerId} {
      // READ: Users can read their own profile
      allow read: if request.auth != null && request.auth.uid == ownerId;
      
      // CREATE: Allow initial setup
      allow create: if request.auth != null && request.auth.uid == ownerId;
      
      // UPDATE: CRITICAL SECURITY FIX
      // Users can update name/email/currency etc.
      // BUT CANNOT update subscription fields (Server-Side Only)
      allow update: if request.auth != null && request.auth.uid == ownerId
                   && notUpdating('subscriptionPlan')
                   && notUpdating('subscriptionStatus')
                   && notUpdating('lastPaymentId');
    }

    // --- 2. PROPERTIES (HOUSES) ---
    match /houses/{docId} {
      allow create: if isValidOwner() && request.resource.data.name is string;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId'); 
      // READ: Restricted to Owner (or Tenant if explicitly linked - for now Owner Only for security)
      allow read: if isOwner(resource.data.ownerId);
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 3. UNITS ---
    match /units/{docId} {
      allow create: if isValidOwner() && request.resource.data.baseRent is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow read: if isOwner(resource.data.ownerId);
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 4. TENANTS ---
    match /tenants/{docId} {
      // READ: Owner OR the Tenant themselves
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid || 
        resource.data.authId == request.auth.uid
      );
      allow create: if isValidOwner() && request.resource.data.name is string;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 5. RENT CYCLES (BILLS) ---
    match /rent_cycles/{docId} {
      allow read: if isOwner(resource.data.ownerId);
      allow create: if isValidOwner() && request.resource.data.totalDue is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 6. PAYMENTS ---
    match /payments/{docId} {
      allow read: if isOwner(resource.data.ownerId);
      allow create: if isValidOwner() && request.resource.data.amount is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 7. EXPENSES ---
    match /expenses/{docId} {
      allow create: if isValidOwner() && request.resource.data.amount is number;
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId');
      allow read, delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 8. ELECTRIC READINGS ---
    match /electric_readings/{docId} {
       allow create: if isValidOwner();
       allow read: if isOwner(resource.data.ownerId);
       allow update, delete: if isOwner(resource.data.ownerId);
    }

    // --- 9. BHK TEMPLATES ---
    match /bhkTemplates/{docId} {
       allow create: if isValidOwner();
       allow read, update, delete: if isOwner(resource.data.ownerId);
    }

    // --- 10. NOTICES ---
    match /notices/{docId} {
      allow read: if request.auth != null;
      allow create: if isValidOwner();
      allow update: if request.auth != null; // Allow tenants to mark as read
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 11. MAINTENANCE ---
    match /maintenance/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null; 
      allow delete: if isOwner(resource.data.ownerId);
    }
  }
}
