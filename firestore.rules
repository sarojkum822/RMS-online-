rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- SECURITY HELPERS ---

    // 1. Check if User is Authenticated & Matches OwnerId
    function isOwner(ownerId) {
      return request.auth != null && request.auth.uid == ownerId;
    }

    // 2. Prevent Changing Critical Fields (Anti-Tamper)
    // Safe version: Handles missing fields without crashing
    function notUpdating(field) {
      return request.resource.data.get(field, null) == resource.data.get(field, null);
    }
    
    // 3. Ensure OwnerId is Correct on Create
    function isValidOwner() {
      return request.auth != null && request.resource.data.ownerId == request.auth.uid;
    }

    // 4. Safe Amount Check (Anti-Spam Strategy: Max 99 Crores)
    function isSafeAmount(val) {
      return val is number && val < 999999999;
    }

    // 5. Safe String Check (Required, Max Length)
    function isSafeString(text, maxLen) {
      return text is string && text.size() <= maxLen && text.size() > 0;
    }

    // 6. Optional String Check (Can be null/missing, but if present, Max Length)
    function isOptionalString(text, maxLen) {
      return text == null || (text is string && text.size() <= maxLen);
    }

    // --- 1. OWNERS COLLECTION ---
    match /owners/{ownerId} {
      // Allow authenticated users to read owner profile (for tenant access to subscriptionPlan)
      // Note: This exposes owner's profile to tenants, but only basic info is stored
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == ownerId
                   // Name: 100, Phone: 20, Email: 100
                   && isOptionalString(request.resource.data.name, 100)
                   && isOptionalString(request.resource.data.phone, 20)
                   && isOptionalString(request.resource.data.email, 100);
      allow update: if request.auth != null && request.auth.uid == ownerId
                   && notUpdating('subscriptionPlan')
                   && notUpdating('subscriptionStatus')
                   && notUpdating('lastPaymentId')
                   // Validation on Update
                   && isOptionalString(request.resource.data.name, 100)
                   && isOptionalString(request.resource.data.phone, 20)
                   && isOptionalString(request.resource.data.email, 100);
    }

    // --- 2. PROPERTIES (Old: houses) ---
    match /properties/{docId} {
      // Name: 50, Address: 200
      allow create: if isValidOwner() && isSafeString(request.resource.data.name, 50) && isOptionalString(request.resource.data.address, 200);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') 
                   && isSafeString(request.resource.data.name, 50) && isOptionalString(request.resource.data.address, 200);
      allow read: if isOwner(resource.data.ownerId);
      allow delete: if isOwner(resource.data.ownerId);
    }
    match /houses/{docId} { // Legacy Support
      allow create: if isValidOwner() && isSafeString(request.resource.data.name, 50) && isOptionalString(request.resource.data.address, 200);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId')
                   && isSafeString(request.resource.data.name, 50) && isOptionalString(request.resource.data.address, 200);
      allow read: if isOwner(resource.data.ownerId);
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 3. UNITS ---
    match /units/{docId} {
      // Name: 30, Rent: 99Cr
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.baseRent) && isSafeString(request.resource.data.nameOrNumber, 30);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId')
                   && isSafeAmount(request.resource.data.baseRent) && isSafeString(request.resource.data.nameOrNumber, 30);
      allow read: if isOwner(resource.data.ownerId);
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 4. TENANTS ---
    match /tenants/{docId} {
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid || 
        resource.data.authId == request.auth.uid
      );
      // Name: 100, Phone: 20, Email: 100
      allow create: if isValidOwner() && isSafeString(request.resource.data.name, 100) 
                   && isSafeString(request.resource.data.phone, 20)
                   && isOptionalString(request.resource.data.email, 100);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId')
                   && isSafeString(request.resource.data.name, 100)
                   && isSafeString(request.resource.data.phone, 20)
                   && isOptionalString(request.resource.data.email, 100);
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 5. CONTRACTS (Old: tenancies) ---
    match /contracts/{docId} {
      // Rent: 99Cr
      allow read: if request.auth != null;
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.agreedRent);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') && isSafeAmount(request.resource.data.agreedRent);
      allow delete: if isOwner(resource.data.ownerId);
    }
    match /tenancies/{docId} { // Legacy Support
      allow read: if request.auth != null;
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.agreedRent);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') && isSafeAmount(request.resource.data.agreedRent);
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 6. INVOICES (Old: rent_cycles) ---
    match /invoices/{docId} {
      allow read: if request.auth != null;
      // TotalDue: 99Cr
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.totalDue);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') && isSafeAmount(request.resource.data.totalDue);
      allow delete: if isOwner(resource.data.ownerId);
    }
    match /rent_cycles/{docId} { // Legacy Support
      allow read: if request.auth != null;
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.totalDue);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') && isSafeAmount(request.resource.data.totalDue);
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 7. TRANSACTIONS (Old: payments) ---
    match /transactions/{docId} {
      allow read: if request.auth != null;
      // Amount: 99Cr
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.amount) && isOptionalString(request.resource.data.notes, 300);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') 
                   && isSafeAmount(request.resource.data.amount) && isOptionalString(request.resource.data.notes, 300);
      allow delete: if isOwner(resource.data.ownerId);
    }
    match /payments/{docId} { // Legacy Support
      allow read: if request.auth != null;
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.amount) && isOptionalString(request.resource.data.notes, 300);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId') 
                   && isSafeAmount(request.resource.data.amount) && isOptionalString(request.resource.data.notes, 300);
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 8. EXPENSES ---
    match /expenses/{docId} {
      // Amount: 99Cr, Description: 300
      allow create: if isValidOwner() && isSafeAmount(request.resource.data.amount) 
                   && isSafeString(request.resource.data.title, 100) 
                   && isSafeString(request.resource.data.category, 50)
                   && isOptionalString(request.resource.data.description, 300);
      allow update: if isOwner(resource.data.ownerId) && notUpdating('ownerId')
                   && isSafeAmount(request.resource.data.amount) 
                   && isSafeString(request.resource.data.title, 100) 
                   && isSafeString(request.resource.data.category, 50)
                   && isOptionalString(request.resource.data.description, 300);
      allow read, delete: if isOwner(resource.data.ownerId);
    }
    
    // --- 9. ELECTRIC READINGS ---
    match /electric_readings/{docId} {
       allow create: if isValidOwner();
       allow read: if isOwner(resource.data.ownerId);
       allow update, delete: if isOwner(resource.data.ownerId);
    }

    // --- 10. BHK TEMPLATES ---
    match /bhkTemplates/{docId} {
       allow create: if isValidOwner();
       allow read, update, delete: if isOwner(resource.data.ownerId);
    }

    // --- 11. NOTICES ---
    match /notices/{docId} {
      allow read: if request.auth != null;
      allow create: if isValidOwner() && isSafeString(request.resource.data.subject, 100) && isSafeString(request.resource.data.message, 1000);
      allow update: if (isOwner(resource.data.ownerId) || (request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'readAt'])))
                   && isSafeString(request.resource.data.subject, 100) && isSafeString(request.resource.data.message, 1000);
      allow delete: if isOwner(resource.data.ownerId);
    }

    // --- 12. TICKETS (Old: maintenance) ---
    match /tickets/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
                   && isSafeString(request.resource.data.category, 100) && isSafeString(request.resource.data.description, 1000);
      allow update: if (isOwner(resource.data.ownerId) || request.auth.uid == resource.data.tenantId)
                   && isSafeString(request.resource.data.category, 100) && isSafeString(request.resource.data.description, 1000);
      allow delete: if isOwner(resource.data.ownerId);
    }
    match /maintenance/{docId} { // Legacy Support
      allow read: if request.auth != null;
      allow create: if request.auth != null
                   && isSafeString(request.resource.data.category, 100) && isSafeString(request.resource.data.description, 1000);
      allow update: if (isOwner(resource.data.ownerId) || request.auth.uid == resource.data.tenantId)
                   && isSafeString(request.resource.data.category, 100) && isSafeString(request.resource.data.description, 1000);
      allow delete: if isOwner(resource.data.ownerId);
    }
    // --- 13. SECURE VAULT ---
    match /users/{userId}/vault/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
